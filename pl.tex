\documentclass{article}

\usepackage{amsmath,amssymb,amsthm,mathtools,stmaryrd}

\usepackage{fullpage}

\usepackage{xcolor}
\usepackage{tikz}

\makeatletter

% theorem environments

\theoremstyle{definition}
\newtheorem{definition}{Definition}
%%
\theoremstyle{plain}
\newtheorem{conjecture} [definition]{Conjecture}
\newtheorem{corollary}  [definition]{Corollary}
\newtheorem{lemma}      [definition]{Lemma}	
\newtheorem{proposition}[definition]{Proposition}
\newtheorem{theorem}    [definition]{Theorem}
%%
\newtheorem*{remark}{Remark}

% coloneqq
\newcommand*\coloneq{
 \mathrel{%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
 {=}}}
\newcommand*\coloneqq{
 \mathrel{%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
 {=}}}

% Small operators:

\newcommand\smallbin[1]{\mathchoice
      {\mathbin{\raise.2ex \hbox{$\scriptstyle      #1$}}}%
      {\mathbin{\raise.2ex \hbox{$\scriptstyle      #1$}}}%
      {\mathbin{\raise.12ex\hbox{$\scriptscriptstyle#1$}}}%
      {\mathbin{           \hbox{$\scriptscriptstyle#1$}}}}%

\newcommand\Con{\wedge}
\newcommand\Imp{\rightarrow}

\newcommand\con{\kern1pt{\smallbin\Con}\kern1pt}
\newcommand\imp{\kern1pt{\smallbin\Imp}}



\newcommand\fv[1]{\mathsf{fv}(\trm{#1})}


% ===== TERMS AND TYPES

% colours
\colorlet{mgray}{black!40}
\colorlet{lgray}{black!25}
\colorlet{llgray}{black!15}

\colorlet{dblue}{blue!80!black}
\colorlet{dred}{red!80!black}

\colorlet{typecolor}{dblue}
\colorlet{termcolor}{dred}

\newcommand\typecolor{\color{typecolor}}
\newcommand\termcolor{\color{termcolor}}

\newcommand\black{\color{black}}
\newcommand\dblue{\color{dblue}}
\newcommand\dred{\color{dred}}


% types
\newcommand\type[1]{{\let\type@sup@color\termcolor\typecolor\typ{#1}}}
\newcommand\typ[1]{%
  %\vphantom J%
  \let\type@loop=\type@next%
  \type@loop#1,%
}
\newcommand\type@next[1]{%
  \ifx#1,\let\type@loop\type@end\else%
  \ifx#1_\let\type@loop\type@sub\else%
  \ifx#1^\let\type@loop\type@sup\else%
  \ifx#1*\con\else%
  \ifx#1-\kern1pt{\imp}\else%
  #1%
  \fi\fi\fi\fi\fi%
  \type@loop%
}
\newcommand\type@sup@color{}
\newcommand\type@sub[1]{_{#1}\let\type@loop\type@next\type@loop}
\newcommand\type@sup[1]{^{{\type@sup@color #1}}\let\type@loop\type@next\type@loop}
\newcommand\type@vec[1]{\vec{\kern.5pt#1\kern.5pt}\let\type@loop\type@next\type@loop}
\newcommand\type@end{\let\type@sup@color\relax}

% terms
\newcommand\x{\lambda x}
\newcommand\y{\lambda y}
\newcommand\z{\lambda z}

\newcommand\term[1]{{\let\term@typecolor\typecolor\termcolor\trm{#1}}}
\newcommand\trm[1]{%
  \vphantom(%
  \let\term@loop=\term@next%
  \term@loop#1,%
}
\newcommand\term@next[1]{%
  \ifx#1,\let\term@loop\term@end\else
  \ifx#1:\black\colon\term@typecolor\let\term@loop\term@type\else%
  \ifx#1_\let\term@loop\term@sub\else%
  \ifx#1^\let\term@loop\term@sup\else%
  \ifx#1!\let\term@loop\term@box\else%
  \ifx#1+\let\term@loop\term@prob\else%
%  \ifx#1\x\lambda x\else%
%  \ifx#1\y\lambda y\else%
%  \ifx#1\z\lambda z\else%
  #1%
  \fi\fi\fi\fi\fi\fi%\fi\fi\fi%
  \term@loop%
}
\newcommand\term@typecolor{}
\newcommand\term@end{\let\term@typecolor\relax}
\newcommand\term@sub[1]{_{#1}\let\term@loop\term@next\term@loop}
\newcommand\term@sup[1]{^{#1}\let\term@loop\term@next\term@loop}
\newcommand\term@vec[1]{\vec{\kern.5pt#1\kern.5pt}\let\term@loop\term@next\term@loop}
\newcommand\term@prob[1]{\kern1pt\overset{#1}{{\smallbin\oplus}}\kern1pt\let\term@loop\term@next\term@loop}
\newcommand\term@type{\let\type@loop=\type@next\type@loop}
\newcommand\term@box[1]{\probox{#1}.\let\term@loop\term@next\term@loop}

\newcommand\probox[1]{\tikz[baseline=(a.base)]\node[draw,line width=.6pt,inner sep=2pt,minimum height=10pt,minimum width=10pt](a){\makebox[0pt][c]{$\scriptstyle #1\vphantom)$}};}

% rewriting
\newcommand\rw{\rightsquigarrow}
\newcommand\dw{\rotatebox[origin=c]{270}{$\rw$}}

\newcommand\prob{\mathsf p}

\newcommand\confluence[4]{\begin{array}{ccc} \trm{#1} & \rw & \trm{#2} \\ \dw && \dw \\ \trm{#3} & \rw & \trm{#4} \end{array}}

\makeatother


%============================================================ FRONTMATTER

\title{Decomposing probabilistic lambda-calculus}

\author{Ugo Dal Lago, Giulio Guerrieri, and Willem Heijltjes}

%============================================================ DOCUMENT

\begin{document}

\maketitle

\[
	M,N \quad\coloneqq\quad x ~\mid~ \x.N ~\mid~ NM ~\mid~ \trm{N +a M} ~\mid~ \trm{!a N}
\]

\[
	\trm{N +{} M} \quad\stackrel\Delta=\quad \trm{!a \, N +a M}
\]


\[
\newcommand\rstrut{\rule{0pt}{13pt}}
\begin{aligned}
	(\x.N)M 				&\rw_\beta N[M/x]
\\
\\	\trm{N +a N}			&\rw_\prob N
\\	\trm{N +a (M +a P)}		&\rw_\prob \trm{N +a P}					\rstrut
\\	\trm{(N +a M) +a P}		&\rw_\prob \trm{N +a P}					\rstrut
\\
\\	\trm{\x.(N +a M)}		&\rw_\prob \trm{(\x.N) +a (\x.M)}
\\	\trm{N (M +a P)}		&\rw_\prob \trm{(NM) +a (NP)}			\rstrut
\\	\trm{(N +a M) P}		&\rw_\prob \trm{(NP) +a (MP)}			\rstrut
\\	\trm{N +b (M +a P)}		&\rw_\prob \trm{(N +b M) +a (N +b P)} 	\rstrut	&& (a\smallbin<b)
\\	\trm{(N +a M) +b P}		&\rw_\prob \trm{(N +b P) +a (M +b P)} 	\rstrut	&& (a\smallbin<b)
\\	\trm{!b (N +a M)}		&\rw_\prob \trm{(!b N) +a (!c M[c/b])}	\rstrut	&& (a\neq b)
\\
\\	\trm{!a N}				&\rw_\prob N 									&& (a\notin N)				
\\	\trm{\x.!a N} 			&\rw_\prob \trm{!a \x. N}				\rstrut
\\	\trm{(!a N)M}			&\rw_\prob \trm{!a (NM)}				\rstrut
\end{aligned}
\]

\[
\begin{array}{ccc@{~}c@{~}c}
	N_0 &\coloneqq& N_1 &\mid& \trm{N_0 +{} N_0}
\\	N_1	&\coloneqq& N_2 &\mid& \x.N_1
\\	N_2 &\coloneqq& x	&\mid& N_2\,N_0
\end{array}
\]


%\end{document}


\begin{lemma}
The reduction $\rw_\prob$ is strongly normalizing.
\end{lemma}

\begin{proof}
The following measure reduces for every step. Order constructors by
\[
	\trm{+a}<\trm{+b} 
	\quad\text{if}\quad
	a<b~,
	\quad\text{and}\quad
	\trm{+a}<\probox b< \x, @ 
\]
(where $a\neq b$ and $@$ stands for application). To each path in the syntax tree of a term, assign the measure of \emph{disorder} as the number of pairs of constructors that are not ordered as above. Let the \emph{disorder} of a term be the multiset of the disorder of its paths. The disorder of a term reduces under $\rw_\prob$.
\end{proof}


\begin{lemma}
The normal forms of $\rw_\prob$ are given by the grammar
\[
\begin{array}{ccc@{~}c@{~}c@{}l}
	P_0 &\coloneqq& P_1 &\mid& \trm{P_0 +{} P_0}
\\	P_1	&\coloneqq& x   &\mid& \x.P_1 			 &~\mid~ P_1\,P_0~.
\end{array}
\]
\end{lemma}

\begin{proof}
By inspection of the rules.
\end{proof}

\begin{lemma}
Reduction $\rw_\prob$ is confluent.
\end{lemma}

\begin{proof}
\begin{itemize}
	\item $\trm{N +a N}\rw N$.

\[
	\trm{N +a (M +a M)} \begin{array}{c}\rw\\[-6pt]\rw\end{array} \trm{N +a M}
\qquad
\begin{array}{c@{~}c@{~}c}
	\trm{(N +a M) +a (N +a M)} &\rw& \trm{N+a M}
\\	\dw & \rotatebox[origin=c]{30}{$\rw$}
\\	\trm{(N +a M) +a M}
\end{array}
\qquad
\begin{array}{c@{~}c@{~}c}
	\trm{C[N +a N]}	&\rw& C[N]
\\	\dw & \rotatebox[origin=c]{30}{$\rw$}
\\	\trm{C[N] +a C[N]}
\end{array}
\]

	\item $\trm{N +a (M +a P)}\rw\trm{N +a P}$.

\[
\begin{array}{c@{~}c@{~}c}
	\trm{C[N +a (M +a P)]} &\rw& \trm{C[N+a M]}
\\	\dw
\\	\trm{C[N] +a C[M+a P]} && \dw
\\	\dw
\\	\trm{C[N] +a (C[M] +a C[P])} &\rw& \trm{C[N] +a C[M]}
\end{array}	
\]

\end{itemize}
\end{proof}

\end{document}

\[
\begin{array}{ccc}
	\trm{(N+aM)+a(P+aQ)} & \rw & \trm{(N+aM)+a Q}
\\	\dw && \dw
\\	\trm{N +a (P+aQ)} & \rw & \trm{N+aQ}
\end{array}{ccc}
\]


\[
\begin{array}{ccc}
	\trm{(\x.N +a M)P} &\rw& \trm{(N +a M)[P/x]}
\\	\dw
\\	\trm{((\x.N) +a (\x.M)) P} && =
\\	\dw
\\	\trm{(\x.N)P +a (\x.M)P} &\rw^*& \trm{N[P/x] +a M[P/x]}
\end{array}
\]

\[
{(\x.N)(M +a P)} {N[M +a P/x]}
{(\x.N)M +a (\x.N)P} {N[M/x] +a N[P/x]}
\]

\[
\trm{(N+aM)(P+aQ)} \trm{N(P+aQ) +a M(P+aQ)} \trm{(NP +a NQ) +a (MP +a MQ)}
\trm{(N+aM)P +a (N+aM)Q} 
\trm{(NP +a MP) +a (
\]


\begin{lemma}
$\trm{N[P+aQ/x]}\rw^*\trm{N[P/x] +a N[Q/x]}$.
\end{lemma}

\begin{proof}
$\trm{x[P+aQ/x]}=\trm{P+aQ}=\trm{x[P/x] +a x[Q/x]}$\\
$\trm{y[P+aQ/x]}=\trm{y}=\trm{y +a y}=\trm{y[P/x] +a y[Q/x]}$\\

$\trm{(\x.N)[P+aQ/x]}=\trm{\x.N}=\trm{(\x.N) +a (\x.N)} = \trm{(\x.N)[P/x] +a (\x.N)[Q/x]}$
$\trm{(\y.N)[P+aQ/x]}=\trm{\x.(N[P+Q/x])}\rw^*\trm{\x.(N[P/x] +a N[Q/x])} \rw \trm{(\x.N)[P/x] +a (\x.N)[Q/x]}$

$\trm{(NM)[P+aQ/x]}=\trm(N[P+aQ/x])(M[P+aQ/x])}\rw^*\trm{(N[P/x] +a N[Q/x])\,(M[P/x] +a M[Q/x])



\end{proof}

%\[
%	\trm{\x.!a !b N +a !f M : A*B}
%\]

\end{document}

%============================================================

