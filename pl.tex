\documentclass{article}

\usepackage{amsmath,amssymb,amsthm,mathtools,stmaryrd}

\usepackage{nicefrac}

\usepackage{fullpage}

\usepackage{xcolor}
\usepackage{tikz}

\makeatletter

% theorem environments

\theoremstyle{definition}
\newtheorem{definition}{Definition}
%%
\theoremstyle{plain}
\newtheorem{conjecture} [definition]{Conjecture}
\newtheorem{corollary}  [definition]{Corollary}
\newtheorem{lemma}      [definition]{Lemma}	
\newtheorem{proposition}[definition]{Proposition}
\newtheorem{theorem}    [definition]{Theorem}
%%
\newtheorem*{remark}{Remark}

% coloneqq
\newcommand*\coloneq{
 \mathrel{%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
 {=}}}
\newcommand*\coloneqq{
 \mathrel{%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
  \rlap{\raisebox{0.3ex}{$\m@th\cdot$}}%
        \raisebox{-0.3ex}{$\m@th\cdot$}%
 {=}}}

% Small operators:

\newcommand\smallbin[1]{\mathchoice
      {\mathbin{\raise.2ex \hbox{$\scriptstyle      #1$}}}%
      {\mathbin{\raise.2ex \hbox{$\scriptstyle      #1$}}}%
      {\mathbin{\raise.12ex\hbox{$\scriptscriptstyle#1$}}}%
      {\mathbin{           \hbox{$\scriptscriptstyle#1$}}}}%

\newcommand\smallsquare{\mathchoice{{\scriptstyle\square}}{{\scriptstyle\square}}{{\scriptscriptstyle\square}}{{\scriptscriptstyle\square}}}

\newcommand\Con{\wedge}
\newcommand\Imp{\rightarrow}

\newcommand\con{\kern1pt{\smallbin\Con}\kern1pt}
\newcommand\imp{\kern1pt{\smallbin\Imp}}



\newcommand\fv[1]{\mathsf{fv}(\trm{#1})}


% ===== TERMS AND TYPES

% colours
\colorlet{mgray}{black!40}
\colorlet{lgray}{black!25}
\colorlet{llgray}{black!15}

\colorlet{dblue}{blue!80!black}
\colorlet{dred}{red!80!black}

\colorlet{typecolor}{dblue}
\colorlet{termcolor}{dred}

\newcommand\typecolor{\color{typecolor}}
\newcommand\termcolor{\color{termcolor}}

\newcommand\black{\color{black}}
\newcommand\dblue{\color{dblue}}
\newcommand\dred{\color{dred}}


% types
\newcommand\type[1]{{\let\type@sup@color\termcolor\typecolor\typ{#1}}}
\newcommand\typ[1]{%
  %\vphantom J%
  \let\type@loop=\type@next%
  \type@loop#1,%
}
\newcommand\type@next[1]{%
  \ifx#1,\let\type@loop\type@end\else%
  \ifx#1_\let\type@loop\type@sub\else%
  \ifx#1^\let\type@loop\type@sup\else%
  \ifx#1*\con\else%
  \ifx#1-\kern1pt{\imp}\else%
  #1%
  \fi\fi\fi\fi\fi%
  \type@loop%
}
\newcommand\type@sup@color{}
\newcommand\type@sub[1]{_{#1}\let\type@loop\type@next\type@loop}
\newcommand\type@sup[1]{^{{\type@sup@color #1}}\let\type@loop\type@next\type@loop}
\newcommand\type@vec[1]{\vec{\kern.5pt#1\kern.5pt}\let\type@loop\type@next\type@loop}
\newcommand\type@end{\let\type@sup@color\relax}

% terms
\newcommand\x{\lambda x}
\newcommand\y{\lambda y}
\newcommand\z{\lambda z}

\newcommand\term[1]{{\let\term@typecolor\typecolor\termcolor\trm{#1}}}
\newcommand\trm[1]{%
  \vphantom(%
  \let\term@loop=\term@next%
  \term@loop#1,%
}
\newcommand\term@next[1]{%
  \ifx#1,\let\term@loop\term@end\else%
  \ifx#1:\black\colon\term@typecolor\let\term@loop\term@type\else%
  \ifx#1_\let\term@loop\term@sub\else%
  \ifx#1^\let\term@loop\term@sup\else%
  \ifx#1!\let\term@loop\term@box\else%
  \ifx#1+\let\term@loop\term@prob\else%
%  \ifx#1\x\lambda x\else%
%  \ifx#1\y\lambda y\else%
%  \ifx#1\z\lambda z\else%
  \ifx#1=\kern1pt{\smallbin=}\kern1pt\else
  #1%
  \fi\fi\fi\fi\fi\fi\fi%\fi\fi\fi%
  \term@loop%
}
\newcommand\term@typecolor{}
\newcommand\term@end{\let\term@typecolor\relax}
\newcommand\term@sub[1]{_{#1}\let\term@loop\term@next\term@loop}
\newcommand\term@sup[1]{^{#1}\let\term@loop\term@next\term@loop}
\newcommand\term@vec[1]{\vec{\kern.5pt#1\kern.5pt}\let\term@loop\term@next\term@loop}
\newcommand\term@prob[1]{\kern1pt\overset{#1}{{\smallbin\oplus}}\kern1pt\let\term@loop\term@next\term@loop}
\newcommand\term@type{\let\type@loop=\type@next\type@loop}
\newcommand\term@box[1]{\probox{#1}.\let\term@loop\term@next\term@loop}

\newcommand\probox[1]{\tikz[baseline=(a.base)]\node[draw,line width=.6pt,inner sep=2pt,minimum height=10pt,minimum width=10pt](a){\makebox[0pt][c]{$\scriptstyle #1\vphantom)$}};}

% rewriting
\newcommand\rw[1][{}]{\stackrel{#1}\rightsquigarrow}
\newcommand\dw{\rotatebox[origin=c]{270}{$\rw$}}

\newcommand\prob{\mathsf p}

\newcommand\confluence[4]{\begin{array}{ccc} \trm{#1} & \rw & \trm{#2} \\ \dw && \dw \\ \trm{#3} & \rw & \trm{#4} \end{array}}

\newcommand\rstrut{\rule{0pt}{13pt}}

% rule names

\newcommand\idem{\ensuremath{\mathsf i}}
\newcommand\cancelL{\ensuremath{\mathsf c_1}}
\newcommand\cancelR{\ensuremath{\mathsf c_2}}
\newcommand\plusAbs{\ensuremath{{\smallbin\oplus}\lambda}}
\newcommand\plusArg{\ensuremath{{\smallbin\oplus}\mathsf a}}
\newcommand\plusFun{\ensuremath{{\smallbin\oplus}\mathsf f}}
\newcommand\plusL{\ensuremath{\mathsf d_1}}
\newcommand\plusR{\ensuremath{\mathsf d_2}}
\newcommand\plusBox{\ensuremath{{\smallbin{\oplus}\smallsquare}}}
\newcommand\boxVoid{\ensuremath{\not{\!\smallsquare}}}
\newcommand\boxAbs{\ensuremath{\smallsquare\lambda}}
\newcommand\boxFun{\ensuremath{\smallsquare\mathsf f}}


\makeatother


%============================================================ FRONTMATTER

\title{Decomposing probabilistic lambda-calculus}

\author{Ugo Dal Lago, Giulio Guerrieri, and Willem Heijltjes}

%============================================================ DOCUMENT

\begin{document}

\maketitle

\newcommand\PEL{$\Lambda_{\textsf{PE}}$}

\begin{definition}
The \emph{probabilistic event $\lambda$-calculus} (\PEL) is given by the following grammar.
\[
	M,N \quad\coloneqq\quad x ~\mid~ \x.N ~\mid~ NM ~\mid~ \trm{N +a M} ~\mid~ \trm{!a N}
\]
\end{definition}

The calculus features a decomposition of the usual probabilistic sum $\trm{+{}}$, as follows,
\[
	\trm{N +{} M} \quad\stackrel\Delta=\quad \trm{!a \, N +a M}
\]
where the name $a$ represents an \emph{event}, a binary value $\{0,1\}$, probabilistically generated by the constructor $\probox a$ and used to create a choice by the constructor $\trm{+a}$. That is, $\probox a$ flips a coin setting $a$ to $0$ or $1$, and depending on this $\trm{N+aM}$ reduces to $N$ respectively $M$.


\begin{definition}
\emph{Reduction} $\rw$ in \PEL\ consists of \emph{beta-reduction} $\rw_\beta$ and \emph{probabilistic} or \emph{p-reduction} $\rw_\prob$, both given in Figure~\ref{fig:reduction rules}.
%\[
%\begin{array}{rcl}
%	C[(\lambda x.N)M] &\rw_\beta& C[M[N/x]]
%\\	\trm{H[\,!a N]} &\rw_p& H[N[0/a]] + H[N[1/a]]
%\end{array}
%\]
\end{definition}


\begin{figure}[!h]
\begin{align}
	(\x.N)M 				&\rw_\beta N[M/x]													\notag
\\																								\notag
\\	\trm{N +a N}			&\rw_\prob N														\tag{\idem}
\\	\trm{(N +a M) +a P}		&\rw_\prob \trm{N +a P}					\rstrut						\tag{\cancelL}
\\	\trm{N +a (M +a P)}		&\rw_\prob \trm{N +a P}					\rstrut						\tag{\cancelR}
\\																								\notag
\\	\trm{\x.(N +a M)}		&\rw_\prob \trm{(\x.N) +a (\x.M)}									\tag{\plusAbs}
\\	\trm{(N +a M) P}		&\rw_\prob \trm{(NP) +a (MP)}			\rstrut						\tag{\plusFun}
\\	\trm{N (M +a P)}		&\rw_\prob \trm{(NM) +a (NP)}			\rstrut						\tag{\plusArg}
\\	\trm{(N +a M) +b P}		&\rw_\prob \trm{(N +b P) +a (M +b P)} 	\rstrut	&& (a\smallbin<b)	\tag{\plusL}
\\	\trm{N +b (M +a P)}		&\rw_\prob \trm{(N +b M) +a (N +b P)} 	\rstrut	&& (a\smallbin<b)	\tag{\plusR}
\\	\trm{!b (N +a M)}		&\rw_\prob \trm{(!b N) +a (!c M[c/b])}	\rstrut	&& (a\neq b)		\tag{\plusBox}
\\																								\notag
\\	\trm{!a N}				&\rw_\prob N 									&& (a\notin N)		\tag{\boxVoid}
\\	\trm{\x.!a N} 			&\rw_\prob \trm{!a \x. N}				\rstrut						\tag{\boxAbs}
\\	\trm{(!a N)M}			&\rw_\prob \trm{!a (NM)}				\rstrut						\tag{\boxFun}
\end{align}

\caption{Reduction rules}
\label{fig:reduction rules}
\end{figure}


\begin{lemma}
The normal forms $P_0$ of $\rw_\prob$ are given by the following grammars
\[
\begin{array}{ccc@{~}c@{~}c@{}l}
	P_0 &\coloneqq& P_1 &\mid& \trm{P_0 +{} P_0}
\\	P_1	&\coloneqq& x   &\mid& \x.P_1 			 &~\mid~ P_1\,P_0
\end{array}
\]
\end{lemma}

\begin{proof}
By inspection of the rules in Figure~\ref{fig:reduction rules}.
\end{proof}


\begin{lemma}
The reduction $\rw_\prob$ is strongly normalizing.
\end{lemma}




\begin{definition}
We define a \emph{context} $C[\,]$ %and \emph{head context} $H[\,]$ 
as follows.
\[
\begin{array}{lll@{~}l@{~}l@{~}l@{~}l}
	C[\,] &\coloneqq& [\,] &\mid& \lambda x.C[\,] &\mid& C[\,]M ~\mid~ NC[\,] ~\mid~ \trm{C[\,]+aM} ~\mid~ \trm{N+aC[\,]} ~\mid~ \trm{!a C[\,]}
%\\	H[\,] &\coloneqq& [\,] &\mid& \lambda x.H[\,] &\mid& H[\,]M 
\end{array}
\]
The term $C[N]$ represents $C[\,]$ with the hole $[\,]$ replaced by $N$.
\end{definition}

Observe that the six reduction rules $\plusAbs$ through $\plusBox$ in Figure~\ref{fig:reduction rules} are all of the following form.
\[
	\trm{C[N+aM]} \rw_\prob \trm{C[N]+aC[M]}
\]


%
%\begin{definition}
%The $a$-\emph{projections} $N[i/a]$ for $i\in\{0,1\}$ of a term $N$ are as follows.
%\[
%\begin{array}{rcl}
%  \rstrut	\trm{x[i/a]}	 	&=& x
%\\\rstrut	\trm{(\x.N)[i/a]}	&=& \trm{\x.(N[i/a])}
%\\\rstrut	\trm{(NM)[i/a]}		&=& \trm{(N[i/a])(M[i/a])}
%\end{array}
%\begin{array}{rcl}
%  \rstrut	\trm{(N_0 +a N_1)[i/a]} &=& \trm{N_i[i/a]}
%\\\rstrut	\trm{(N +b M)[i/a]} 	&=& \trm{(N[i/a]) +b (M[i/a])}
%\\\rstrut	\trm{(!b N)[i/a]}  		&=& \trm{!b (N[i/a])}
%\end{array}
%\]
%\end{definition}



%
%\begin{proof}[Sketch]
%The following measure reduces for every step. Order constructors by
%\[
%			\trm{+a}
%\smallbin<	\trm{+b}
%\smallbin<	\probox c
%\qquad
%(a\smallbin<b\smallbin<c)
%\]
%(where $@$ stands for application). We consider sequences of these, ordered lexicographically. 
%\end{proof}

\begin{lemma}
Reduction $\rw_\prob$ is confluent.
\end{lemma}

\begin{proof}
We consider each reduction rule against those lower down in the table in Figure~\ref{fig:reduction rules}.
\begin{itemize}
	\item $\trm{N +a N}\rw N$.

\[
	\trm{N +a (M +a M)} \begin{array}{c}\rw\\[-6pt]\rw\end{array} \trm{N +a M}
\qquad
\begin{array}{c@{~}c@{~}c}
	\trm{(N +a M) +a (N +a M)} &\rw& \trm{N+a M}
\\	\dw & \rotatebox[origin=c]{30}{$\rw$}
\\	\trm{(N +a M) +a M}\rstrut
\end{array}
\qquad
\begin{array}{c@{~}c@{~}c}
	\trm{C[N +a N]}	&\rw& C[N]
\\	\dw & \rotatebox[origin=c]{30}{$\rw$}
\\	\trm{C[N] +a C[N]}\rstrut
\end{array}
\]

	\item $\trm{N +a (M +a P)}\rw\trm{N +a P}$.

\[
\begin{array}{c@{~}c@{~}c}
	\trm{(N+aM)+a(P+aQ)} & \rw & \trm{(N+aM)+a Q}
\\	\dw && \dw
\\	\trm{N +a (P+aQ)} & \rw & \trm{N+aQ} \rstrut
\end{array}
\qquad
\begin{array}{c@{~}c@{~}c}
	\trm{C[N +a (M +a P)]} &\rw& \trm{C[N+a M]}
\\	\dw
\\	\trm{C[N] +a C[M+a P]} && \dw
\\	\dw
\\	\trm{C[N] +a (C[M] +a C[P])} &\rw& \trm{C[N] +a C[M]}
\end{array}	
\]

\[
\begin{array}{c@{~}c@{~}c}
	\trm{(N+aM)+b(P+bQ)} & \rw & \trm{(N+aM)+b Q}
\\	\dw && \dw
\\	\trm{(N+b(P+bQ))+a(N+b(P+bQ))} & \rw^* & \trm{(N+bQ)+a(M+bQ)} \rstrut
\end{array}
\]

	\item $\trm{C[N+aM]}\rw\trm{C[N]+a C[M]}$.
	
\[	
\begin{array}{c@{~}c@{~}c}	
	\trm{C[N +a (M +b P)]} &\rw& \trm{C[N]+a C[M+b P]}
\\	\dw && \dw	
\\	\trm{C[(N+a M)+b(N+a P)]} && \trm{C[N]+a (C[M] +b C[P]} \rstrut
\\	\dw && \dw
\\	\trm{C[N+a M]+b[N+a P]}	&\rw& \trm{(C[N]+a C[M])+b(C[N]+aC[P]]} \rstrut
\end{array}
\]


	\item $\trm{N +b (M +a P)}\rw\trm{(N +b M) +a (N +b P)}$.

\[
\begin{array}{c@{~}c@{~}c}	
	\trm{(N+a Q)+b(M+a P)} &\rw& \trm{((N+a Q) +b M) +a ((N+a Q) +b P)}
\\	\dw && \dw_*
\\	\trm{(N+b(M+a P))+a(Q+b(M+a P))} && \trm{((N +b M)+a (Q +b M)) +a ((N +b P)+a(Q +b P))} \rstrut
\\	\dw_* && \dw_*
\\	\trm{((N+b M) +a (N+b P)) +a ((Q +b M) +a (Q +b P))} &\rw^*& \trm{(N+b M)+a(Q+b P)} \rstrut
\end{array}
\]

	\item $\trm{!b (N +a M)} \rw \trm{(!b N) +a (!c M[c/b])}$
	
\[
\begin{array}{c@{~}c@{~}c}	
	\trm{!b (N +a M)} &\rw& \trm{(!b N) +a (!c M)}
\\	\dw & \rotatebox[origin=c]{210}{$\rw_*$}
\\	\trm{N +a M} && (b \notin\trm{N+a M})
\end{array}
\]

\end{itemize}
\end{proof}


\begin{lemma}
The normal forms $N_0$ of $\rw$ are given by the following grammars.
\[
\begin{array}{ccc@{~}c@{~}c}
	N_0 &\coloneqq& N_1 &\mid& \trm{N_0 +{} N_0}
\\	N_1	&\coloneqq& N_2 &\mid& \x.N_1
\\	N_2 &\coloneqq& x	&\mid& N_2\,N_0
\end{array}
\]
\end{lemma}




\end{document}

%============================================================

